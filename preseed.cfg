# RAID1 preseed - Manual partitioning via UI, then automated setup
# Locale and language
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us

# Network configuration
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string knarr
d-i netcfg/get_domain string knarr.star

# Mirror settings
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

# Repository configuration
d-i apt-setup/use_mirror boolean true
d-i apt-setup/security_updates boolean true

# Clock and time zone
d-i clock-setup/utc boolean true
d-i time/zone string UTC

# KEY CHANGE: Skip automatic partitioning - let user handle via UI
# Comment out or remove these lines to force manual partitioning UI:
# d-i partman-auto/method string ...
# d-i partman-auto/disk string ...
# d-i partman-auto/expert_recipe string ...

# Clean up any existing RAID/LVM when user starts partitioning
d-i partman-md/device_remove_md boolean true  
d-i partman-lvm/device_remove_lvm boolean true

# Set defaults for when user creates filesystems
d-i partman/mount_style select uuid
d-i partman/default_filesystem string ext4

# Don't auto-confirm partitioning - let user review and confirm
d-i partman/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Disable swap creation
d-i partman-basicfilesystems/no_swap boolean false

# Root password
d-i passwd/root-password-crypted string $6$3Ek6z.w6yocYuNpJ$WVrWogbYCjBYx/sNfWQ7hRqfkntrgTIa6A4OAt/M.7syHNuRK3sFpyt/6LabYheIpESbTwMlN1vKuP/dYWV3U1

# Create heimdall user
d-i passwd/user-fullname string heimdall
d-i passwd/username string heimdall
d-i passwd/user-password-crypted string $6$vIO6S60WI3GqOEzh$qwKN2DjUnCVzFQQ8bET/yXnwx3XrAMj1pGO9jkWJ.u4BZeXTMLLk.cfijHdtChvB3YC7KhhB/W7MXPUy/xh7s/
d-i passwd/user-default-groups string sudo,adm,systemd-journal

# Package selection - ensure RAID tools are installed
d-i pkgsel/include string mdadm
d-i tasksel/first multiselect standard
d-i pkgsel/upgrade select full-upgrade

# Bootloader - install on both drives (assuming RAID1 setup)
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/sda /dev/sdb

# Late command - finalize RAID configuration after manual partitioning
d-i preseed/late_command string \
  echo "=== Finalizing RAID1 configuration after manual partitioning ==="; \
  \
  echo "Installing and configuring mdadm..."; \
  in-target apt-get update; \
  in-target apt-get install -y mdadm; \
  \
  echo "Scanning for RAID arrays..."; \
  mdadm --detail --scan > /target/etc/mdadm/mdadm.conf.new; \
  if [ -s /target/etc/mdadm/mdadm.conf.new ]; then \
    echo "DEVICE partitions" > /target/etc/mdadm/mdadm.conf; \
    cat /target/etc/mdadm/mdadm.conf.new >> /target/etc/mdadm/mdadm.conf; \
    echo "Updated mdadm.conf with discovered arrays"; \
  else \
    echo "No RAID arrays detected - skipping mdadm configuration"; \
  fi; \
  \
  echo "Current RAID status:"; \
  cat /proc/mdstat || echo "No active RAID arrays"; \
  \
  echo "Updating initramfs to include RAID support..."; \
  in-target update-initramfs -u; \
  \
  echo "Updating GRUB configuration..."; \
  in-target update-grub; \
  \
  echo "Downloading knarr setup script..."; \
  wget -O /target/root/knarr_setup.sh https://raw.githubusercontent.com/landNull/knarr/main/knarr_setup.sh || echo "Failed to download knarr setup script"; \
  chmod +x /target/root/knarr_setup.sh; \
  \
  echo "Checking final filesystem mounts:"; \
  mount | grep "/target" || echo "No target mounts found"; \
  \
  echo "RAID1 post-installation configuration completed";

# Finish installation
d-i finish-install/reboot_in_progress note
